<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Iraje Test Management Portal</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f5f5f5; }
  h1, h2, h3 { margin-top: 20px; }
  section { margin-bottom: 30px; padding: 20px; background:#fff; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  ul.checklist { list-style:none; padding:0; }
  li { margin-bottom:10px; padding:10px; border-bottom:1px solid #eee; border-radius:5px; display:flex; flex-direction: column; background:#fafafa;}
  li:nth-child(even){background:#f0f8ff;}
  label { font-weight: bold; margin-bottom:5px; }
  select, input[type="text"], textarea { margin:5px 0; width:100%; max-width:600px; padding:6px; border-radius:4px; border:1px solid #ccc; }
  input[type="file"] { margin-top:5px; }
  .image-preview img { max-width:150px; margin-top:5px; border-radius:4px; }
  button { margin:5px 8px 20px 0; padding:10px 14px; border:none; border-radius:5px; background:#007BFF; color:#fff; cursor:pointer; }
  button:hover { background:#0056b3; }
  .print-hide { display:inline-block; }
  .cover-page { text-align:center; page-break-after: always; margin-top:150px; background:#007BFF; color:#fff; padding:50px; border-radius:8px;}
  .cover-page h1 { font-size:36px; margin-bottom:20px; }
  .cover-page h2 { font-size:20px; margin:10px 0; }
  .logo { max-width:200px; background:#fff; border-radius:6px; padding:6px; display:inline-block; }
  #summaryTable { width:100%; border-collapse: collapse; margin-top:20px;}
  #summaryTable th, #summaryTable td { border:1px solid #ccc; padding:8px; text-align:center; }
  #summaryTable th { background:#007BFF; color:#fff; }
  .toolbar { display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin:10px 0 20px; }
  .sheet-picker { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999; }
  .sheet-modal { background:#fff; padding:20px; width:90%; max-width:560px; border-radius:8px; box-shadow:0 8px 32px rgba(0,0,0,0.3); }
  .sheet-list { max-height:320px; overflow:auto; border:1px solid #eee; padding:10px; border-radius:6px; }
  .hint { color:#666; font-size:13px; }
  .meta { color:#444; font-size:12px; }
  .badge { display:inline-block; padding:2px 6px; border-radius:10px; background:#eee; font-size:11px; margin-left:6px; }
  @media print {
    .print-hide, .toolbar { display:none !important; }
    input, select, textarea, button { display:none !important; }
    img { max-width:100%; height:auto; }
    section { page-break-after: always; }
    footer { position:fixed; bottom:0; width:100%; text-align:right; font-size:12px; }
    footer:after { counter-increment: page; content: "Page " counter(page); }
  }
</style>
</head>

<title>Iraje Test Management Portal</title>
<link rel="stylesheet" href="css/styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<!-- Cover Page -->
<div class="cover-page">
  <img class="logo" id="coverLogo" alt="Iraje Logo" />
  <h1>Iraje EPM Testing Report</h1>
  <h2>Build: V1</h2>
  <h2>Build: V1</h2>
  <h2>Date: <input class="print-hide" type="text" id="reportDate" placeholder="DD/MM/YYYY" oninput="saveHeader()" /></h2>
  <h2>Tester: <input class="print-hide" type="text" id="testerName" placeholder="Name" oninput="saveHeader()" /></h2>
</div>
<div class="toolbar">
  <input class="print-hide" type="file" id="excelFile" accept=".xlsx,.xls" />
  <button class="print-hide" id="btnImport">Import Excel</button>
  <button class="print-hide" onclick="window.print()">Print</button>
  <button class="print-hide" onclick="exportDocx()">Export to DOCX</button>
  <button class="print-hide" onclick="clearStorage()">Clear Saved Data</button>
  <span class="meta" id="loadInfo"></span>
</div>

<!-- Sections rendered here -->
<div id="sectionsRoot"></div>

<!-- Automated Summary -->
<section id="summary"><h2>Automated Summary</h2>
  <table id="summaryTable">
    <thead>
      <tr><th>Module</th><th>Total</th><th>Passed</th><th>Failed</th><th>% Pass</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section class="signature">
  <h2>Tester Signature</h2>
  <input class="print-hide" type="text" placeholder="Signature / Name" id="signature" oninput="saveHeader()">
</section>

<footer></footer>

<!-- Sheet picker modal -->
<div class="sheet-picker" id="sheetPicker">
  <div class="sheet-modal">
    <h3>Select sheets to import</h3>
    <p class="hint">Tick one or more sheets below. You can re-import any time to rebuild UI.</p>
    <div class="sheet-list" id="sheetList"></div>
    <div style="margin-top:12px;">
      <button onclick="applySheetSelection()">Build Checklist</button>
      <button onclick="closeSheetPicker()">Cancel</button>
<!-- Navigation Tabs -->
<div class="navigation-container print-hide">
  <div class="nav-tabs">
    <button class="nav-tab active" data-page="workspace">
      üìù Workspace
    </button>
    <button class="nav-tab" data-page="status">
      üìä Status Dashboard
    </button>
    <button class="nav-tab" data-page="reports">
      üìã Reports
    </button>
    <button class="nav-tab" data-page="summary">
      üìã Summary Report
    </button>
  </div>
</div>

<!-- Enhanced Toolbar -->
<div class="toolbar enhanced-toolbar print-hide" id="workspaceToolbar">
  <!-- File Import Section -->
  <div class="toolbar-group file-group">
    <div class="file-input-wrapper">
      <input class="print-hide" type="file" id="excelFile" accept=".xlsx,.xls,.csv,.tsv" />
      <label for="excelFile" class="file-label">
        <i class="fas fa-folder-open"></i>
        Browse Files
      </label>
      <button class="clear-file-btn print-hide" id="clearFileBtn" onclick="clearFileSelection()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <button class="btn-primary print-hide" id="btnImport">
      <i class="fas fa-upload"></i>
      Import Excel
    </button>
  </div>

  <!-- Project Actions Section -->
  <div class="toolbar-group project-group">
    <button class="btn-success print-hide" id="saveProjectBtn">
      <i class="fas fa-save"></i>
      Save Changes
    </button>
    <button class="btn-info print-hide" id="downloadTemplateBtn">
      <i class="fas fa-download"></i>
      Download Template
    </button>
  </div>

  <!-- Data Actions Section -->
  <div class="toolbar-group data-group">
    <button class="btn-danger print-hide" id="clearDataBtn" onclick="showClearDataModal()">
      <i class="fas fa-trash-alt"></i>
      Clear Saved Data
    </button>
    <button class="btn-danger delete-sheet-btn print-hide" id="deleteSheetBtn" onclick="showDeleteSheetModal()" style="display: none;">
      <i class="fas fa-exclamation-triangle"></i>
      Delete All Test Cases
    </button>
  </div>

  <span class="meta" id="loadInfo"></span>
</div>

<!-- Page Content Container -->
<div class="page-content">
  
  <!-- Workspace Page -->
  <div class="page" id="workspacePage" data-page="workspace">
    <!-- Simplified Empty State Message -->
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">
        <i class="fas fa-file-excel"></i>
      </div>
      <h3>No Test Cases Imported Yet</h3>
      <p>Import your Excel test case file using the toolbar above to get started with test execution management.</p>
    </div>

    <!-- Test Cases Container -->
    <div id="sectionsRoot" style="display: none;"></div>
  </div>

  <!-- Enhanced Status Dashboard Page -->
  <div class="page" id="statusPage" data-page="status" style="display: none;">
    <div class="status-dashboard">
      <div class="dashboard-header">
        <div>
          <h2>üìä Module Status Dashboard</h2>
          <p class="dashboard-subtitle">Real-time overview of test execution progress across modules</p>
        </div>
        <button class="refresh-btn" id="refreshStatusBtn" onclick="Dashboard.refreshStatus()">
          <i class="fas fa-sync-alt" id="refreshIcon"></i>
          <span>Refresh Status</span>
        </button>
      </div>
      
      <!-- Dashboard Overview Cards -->
      <div class="dashboard-overview">
        <div class="overview-card total-card">
          <div class="card-icon">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div class="card-content">
            <div class="card-number" id="totalTestsCard">0</div>
            <div class="card-label">Total Tests</div>
          </div>
        </div>
        
        <div class="overview-card passed-card">
          <div class="card-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="card-content">
            <div class="card-number" id="passedTestsCard">0</div>
            <div class="card-label">Passed Tests</div>
          </div>
        </div>
        
        <div class="overview-card failed-card">
          <div class="card-icon">
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="card-content">
            <div class="card-number" id="failedTestsCard">0</div>
            <div class="card-label">Failed Tests</div>
          </div>
        </div>
        
        <div class="overview-card blocked-card">
          <div class="card-icon">
            <i class="fas fa-ban"></i>
          </div>
          <div class="card-content">
            <div class="card-number" id="blockedTestsCard">0</div>
            <div class="card-label">Blocked Tests</div>
          </div>
        </div>
      </div>

      <!-- Module Details -->
      <div id="statusDashboard">
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-chart-bar"></i>
          </div>
          <h3>No Test Data Available</h3>
          <p>Import test cases to view module status dashboard.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Reports Page -->
  <div class="page" id="reportsPage" data-page="reports" style="display: none;">
    <div class="reports-section">
      <div class="reports-header">
        <div>
          <h2>üìã Test Reports Generator</h2>
          <p class="reports-subtitle">Generate professional reports in multiple formats (PDF, HTML, DOCX)</p>
        </div>
        <button class="refresh-btn" id="refreshReportsBtn" onclick="ReportGenerator.refreshReports()">
          <i class="fas fa-sync-alt" id="refreshReportsIcon"></i>
          <span>Refresh Reports</span>
        </button>
      </div>
      
      <div class="reports-grid">
        
        <!-- Defect Report -->
        <div class="report-card">
          <div class="report-icon">üêõ</div>
          <h3>Defect Report</h3>
          <p>Comprehensive report of all failed test cases with detailed analysis and screenshots</p>
          <div class="report-stats" id="defectStats">
            <span class="stat-number">0</span>
            <span class="stat-label">Failed Tests</span>
          </div>
          <div class="report-formats">
            <span>Available in: PDF ‚Ä¢ HTML ‚Ä¢ DOCX</span>
          </div>
          <button class="report-btn" onclick="ReportGenerator.generateDefectReport()">
            Generate Defect Report
          </button>
        </div>

        <!-- Full Report -->
        <div class="report-card">
          <div class="report-icon">üìä</div>
          <h3>Full Test Report</h3>
          <p>Complete test execution report with all test cases, status, and detailed execution logs</p>
          <div class="report-stats" id="fullStats">
            <span class="stat-number">0</span>
            <span class="stat-label">Total Tests</span>
          </div>
          <div class="report-formats">
            <span>Available in: PDF ‚Ä¢ HTML ‚Ä¢ DOCX</span>
          </div>
          <button class="report-btn" onclick="ReportGenerator.generateFullReport()">
            Generate Full Report
          </button>
        </div>

        <!-- Security Report -->
        <div class="report-card">
          <div class="report-icon">üîí</div>
          <h3>Security Report</h3>
          <p>Focused report on security-related test cases with risk assessment and compliance status</p>
          <div class="report-stats" id="securityStats">
            <span class="stat-number">0</span>
            <span class="stat-label">Security Tests</span>
          </div>
          <div class="report-formats">
            <span>Available in: PDF ‚Ä¢ HTML ‚Ä¢ DOCX</span>
          </div>
          <button class="report-btn" onclick="ReportGenerator.generateSecurityReport()">
            Generate Security Report
          </button>
        </div>

        <!-- Enhancement Report -->
        <div class="report-card disabled">
          <div class="report-icon">‚ö°</div>
          <h3>Enhancement Report</h3>
          <p>Advanced analytics and improvement recommendations based on test execution patterns</p>
          <div class="report-stats">
            <span class="stat-number">Soon</span>
            <span class="stat-label">Coming</span>
          </div>
          <div class="report-formats">
            <span>Multi-format support</span>
          </div>
          <button class="report-btn" disabled>
            Coming Soon
          </button>
        </div>

      </div>

      <!-- Report History -->
      <div class="report-history">
        <h3>Recent Reports</h3>
        <div id="reportHistoryList">
          <p class="no-reports">No reports generated yet. Generate your first report above!</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Enhanced Summary Report Page -->
  <div class="page" id="summaryPage" data-page="summary" style="display: none;">
    <div class="summary-report">
      <div class="summary-header">
        <div>
          <h2>üìã Test Execution Summary</h2>
          <p class="summary-subtitle">Comprehensive overview of test execution progress and results</p>
        </div>
        <div class="summary-actions">
          <button class="refresh-btn" id="refreshSummaryBtn" onclick="Summary.refreshSummary()">
            <i class="fas fa-sync-alt" id="refreshSummaryIcon"></i>
            <span>Refresh Summary</span>
          </button>
          <button class="btn-export-summary" id="exportSummaryBtn" onclick="exportSummary()">
            <i class="fas fa-file-export"></i>
            Export Summary
          </button>
        </div>
      </div>
      
      <!-- Automated Summary Table -->
      <section id="summary">
        <table id="summaryTable">
          <thead>
            <tr>
              <th>Module</th>
              <th>Total</th>
              <th>Passed</th>
              <th>Failed</th>
              <th>Blocked</th>
              <th>% Pass</th>
              <th>Attended</th>
              <th>Pending</th>
              <th>Progress</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Signature Section -->
      <section class="signature">
        <h2>Tester Signature</h2>
        <input class="print-hide" type="text" placeholder="Signature / Name" id="signature" oninput="saveHeader()">
      </section>
    </div>
  </div>

</div>

<footer></footer>

<!-- Enhanced Sheet picker modal -->
<div class="sheet-picker" id="sheetPicker">
  <div class="sheet-modal">
    <div class="sheet-header">
      <h3>üìä Select sheets to import</h3>
      <button class="sheet-close" onclick="closeSheetPicker()">√ó</button>
    </div>
    <div class="sheet-body">
      <p class="sheet-hint">Select one or more sheets to import. You can re-import anytime to update your workspace.</p>
      <div class="sheet-list" id="sheetList"></div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" onclick="applySheetSelection()">
        <i class="fas fa-check"></i> Import Selected Sheets
      </button>
      <button class="btn-secondary" onclick="closeSheetPicker()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<<<<<<< HEAD
<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>

<script>
// =========================
// -------------------------
// CONFIG: Safe to edit
// -------------------------
const CONFIG = {
  LOGO_DATA_URL: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAA+CAYAAADj/hPOAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABWZSURBVHgB7V0JdFRVmr73bfVeVfYAAY2AkJCFCiEEiYC2UXpQTmu3ILjTyozoqAe0Z2R6PKNOHEdbUbu1Rz223bY6Lox60AYF2wWMInvCkj1hh7Bkr6TWt903/w0Qi6pXlVdJbKSp7xxPrPvevfW///7331+BUBxxxBFHHHHEEUcc5x0wGmKszcqyOe0p2TZFvUDn2COj5v+8EZeVERQHOjB2rGhPTc1BKsnQVP7QBQ3bmzDGBjqLGFIBaC4pyRRau//MqtpV8JFFGCuawL7VyaOH8xoaOtB5jBOTZoxguzs+YnR9OnxkDIxljWP/cNwQ/7Po4C4XOktg0BABxBhzbe7/gs3/B0Q3v3fQEDhZX5RqMIXoPIZRVsYgb+cLsPkz0SmeY8OwcZp+zwWcNg2dRQyZABzNLczmVOX68CsGx6pkMjqPceid9ydzsnZt6DgVAqxrU9FZxJAJgKAGxsEfu9k1wmA/Oo9h10kWjsQbjH3oLGLIBEA3GDbCJaIiYxc6j0E0g6HnPfwK1pANbUFnEUMmAJ5kcRtI85HgMQMZROXZNzrsQhU6j+FLcGwmGLUEjxlULgTuT/vd7t3oLGJIo4Cjuc7Zgl99GBEyhsHIS1jmr7INP515nkcAFCdyndcyfvlxTIwLITpyI4b9RB6R9GTmtm1/X7zZNH261JVXNKZ52rR0wzCGPM9wLuPA5NKUg2Oy89qKi0eV0cggjjjiiCOOOP6OUFxczGdBPQANHHgs5MwXLFjARruptLSUGzVqlD0/P19AgwC1xZmZmRJdi9IdyW/pjx4roDTT70JD7HxTminPTj9DLOsPCSGUiatWrBopE9/Vuq7/DCo/hkNMeHJX3S7L8X/vGu+vukjWvTfIqnqVjeWrFEQe37t3rxx8H92IxtraGQFZWUiIPhYjrNgc9mU1NTX1KAZMAyfV0919marrV9OohehEZFkmAOsdZjh2My+K6+fNm3eM3rt69eqcgNv7gE0UVuysrv4mlu+hmwNCOhI8vivUgDIXQmNJtAm/qW5o2IwGB5yXlzcS1p+uK9pPMTLGAu9tLMv2sCxXkZpgf2fTzp2H+l0EDRJFRUXDZa//Lk1V7tAJyUancgtAyIqm/ftuQ70hb3TMnj3b0Xzw4BJd02/VdN1J6QK47XZpblVd3brT982ZM8d2aN++MkVRH4QHF08N+ySem1Szd+8+ZAHT4QS6RMedOtHuB4blowg8wJhxcRy7Bqjv0Ii+0CAkiRfEhQ17GlYgi5iWm5vu0fVFqkZuBWGl9ZBe3nAs917j/r23Iwu8MUNxQUGu1+tfTAwyF3g+1uwZGIw7RLv0TzpCn9XV1SmR1uLQIDB18uSZPd3u53VduwSFJJV0nVwE5oCrrKxUo60xceLESw7t2/+CpmmXBq8BG2wHYUgL+oydufnLZFn5t+D7GJZpYuz2E8gC4NRP6Oxy/U5T5DnoJNOMU/+FMdAwSIqqkttOf8YM05omCeuQRUwG3rjcnuV6yHNR6IiMBE3GfPjhhzqKASVZWUkenr+3x+1ZSgzjAqC6h2FwI7CGB4pHA4/40/fC9fSAP/AHm8DPho8RE3EDEoCSkpIkt6vnEVdX972g0hLM7mFZ3HPdddfpIACmawADhPra2qUBr+9RIDwp9DpoAC8y2OOnPxfmOX8py4FHUQgz4b5du3fv9sFfFAnU9ra3tC/ubG17BL7rAjjZ1SzDvYIxt5lhdAKbNE4j5AoD4RuIro82WwOzzIZNVVVtqB9MmjTJAar+CU9X9+JIvIGkcNcHH3xAotEcDOpXKX7/9Z1++Wmi+i+mWUSbYFuOefaPoMVaBEHgQKoW+L2el+E7+/aUEJIBGuIXaCgFgJ4iV1v7K3A6r0RRUskGYg6VRWgEAQHKqN5V9bymKDcFExwCj5Qo9ap1YGqOr8f9DGyeicPH1kRrqsjJyUlsO3biIVmRH4D5ycCsrRlJideWV1a2B91WDbR+smbNmuU9Xa7fa6q6IHQdeNB1qB+VPWXKlEm+np4XVVW7AkUxr2BeDlttBAH/IcHv8fw7mL17wAwNozTYRNtTmGX/O1i1A/1/WvH2O3NBk14TPF9T9bxo61sWgF7nq7ru9s6WtpeoZFMbA0QE4PRcaHI7rX5Um61T5Cya2tXW8TaYjRzwEyrAYalWFHkRCmEYMKgZtMdxOL3iiaNHn4LNyzBbT+CZRhQBs2bNSm8+ePj9gKbOop8Zhj2WKKXcUl65rT303lPCeiJ73DjTtQRJ+jrS91Bt1lhXdx8ITxlsUjLDsoeprIBjaaZNCGbYWmQBNMIhsvqxqqk/7aOD51bVNzY+hkzoHz9mDPAcnyEAmMVytO+wlI6kjl7N7t2v+gK+P4J3ccwmictmjr0iE9zZhbAxYZIMnrQXPOYdoeMlRUX5Hm/3amLoEjgoSwqLp1wm2MXHYLO7TdboVVudLS23a6p23alhukl+kI7TfoXBsWyLGc1Uaxw5cGiNdmrze+9lmNe3VW07iCKgNz1roLDeBbD/LVVVVaaCVlBQMK5q5653fV7fcjjTRwW79C+3/XLheJsoLjO7H57VI3C43+hoOqTUDVVdEbz5AB/i+WcizQEn9eKw70NM1OjIkgBoslaqKup8luPeTh8xfFZdQ8Nzb5a/GZB1PRWbGTKMjvOSFKYB3LLcyXLs+qTU1Jtr6+tfBieoV4XBEmF0cBxXCY5Uil9WfgUyBo4zV2+zCcskQfqFjRMWgSpfhylDCAlrpwKBHQO+xZugZUr6SMK4nUXsX1EUNb72o7VjwG6ODx1nMbMhksoGe/8IaMHZQOAbyYmO6+rr638HggQuBTHXrobRJjgc/YWs2N3dvRjU/rwz6GC59TzPm2rWmTNnJuqqdmUoeQLPbkBRYEkABE3+Ojk57bpRmRfes3Xr1ua+yZp5NwsQug7Ud1ijA9isFkdS0qIdO3Z8XwOXZYdBjNBmCZLoSFmn+uUl4JTlwmavGT8h+9K6pqbf1uyp/7Jub+O79qTEOfbkpEt31dfvCZ5ITzHE7I+e8r6DaGI2ExtTgaKgJ+C6BZnwhOH4iOo/wS6+KiUm3FwwZfJ9FdXV+79/AjLB7H6W57eY8SYY0woLswM+/+Mhwwb4em+AJvKazelsbf9n0KzpwWMgLOXTHT+J+syWfIDKpiZqM78LHVcJMhUAnmG/ROYwQsNClZARoY4gyzBHJBvyd3bL98P/b09LSrz/s88+6zmDppPr1IR+wScrV06AuP3q0HHQIKuixcM0zMwdn3VT2DhcAa3zXaR5Fbt3b6N/q6vPPJiqppkLAEYR1zoF7Pb6qcOacsYgxl2MIJjOhShhWE9n190h97sgQfbr1ypfixqGD6YkyRonkxuh0G0ctpzlgmgizImEkGtdS6frFmCCJPHiQxsrKw8ji/D65TtI+JodAsNEVYVgy4uBloLQcQYSQuPzxlty2oIBBiPLbJxhomuhory80aqq3By2HsYVkJkMc15h85O9ru63weRkBX3HcYgU7oPweCfqBwMWgCnOKRNhg4aHjoPt3l1RV2cpMUMBTsqYsDV4W42uq/fDWp9widJWZBEzIeSj9hiFRBSwiQcVjKOmRYmsLEZmGTWGqY81YUOn6YaRHTaKsZw8bFhjtIkyIdPA2UgNHQcTtjE0rC4sLLzQ0+1+Tg0K/UBjNnCw+cNHjvwQWSEUDRBev5t65iYMY/8vppcdDCP01BFEtHyILRwpw9Kf7C+TGAyPKGZBejRMKwk8vzaa+p9aWDhNUdWbza7B88ScswcbngXPlRw6zrFMxcaNG91RpjKQDp+PwviKA6D++/yQO++8U3Tm5y+F3MgmSMHf1XsHxj5RtD0zYWJ+MTiifykvL9eQBQw0FQwEGvNMxklKouNjFAMIMkLDLiYQkBfBpr21ZcuWmAo8UJO4EZ1+J+F7+HiB+zzSHJpnOHa4eQnkJJIgq4ZColqD59n1KEZ4fPIMZJZexvjLaPOcWc6LA7rPJAzFR0Abqvk5OQsg0TN/4zffzgaVT30EH2i3Ws7G/68giu+Cyj9a2xhVwYRhQAIAIceoE81Hw04axOR1m3fs2IssApif0HzwULbJJSzY7O+gGAC20O7ucv0kfCXcZktIqI40r72l5XLwnq9JT0tv7GjvyDlzKnZxSIzZ/hPDPDqy8fzGaPM0pGWCBIaZRBgbHXB7PoK0bkZvihzI5nj+I4HhPpFSEjdsG0Rf4YAEAJhGiylh9XGQ1NUoBnS2tpbAiQvrHQCPfffcBXO/2V1rvWEWTkYmnIowxoNNrIHQtcdsDq0u7mtsegr8EMUfCLwItLwSfB3sf51bdVv2Z06DEOPy0DHYOCU9I2MLqo+s1HRDLzTjB8w9CNnDD6FEvp1jUaMjLe3w5s2bh+Rdi4GZAANdYTaMeX4TigGyLE83Gwe19kFZjC+Uyj5fgWmtwECmUkQLLIf2HfgVnCqnKPBLlIASlgACzm8J7UfoD7QYBLY5J2wpBteDXfZEmcowhp5v8tCE5bmXGpqaXkI/AGJ2AmmKEk5a2PtskC7tgoRNTC+AgLmdYjKsMwIXs90FA+s0G5YckmklTPF6Z0AN4mFIWq2FzNwqQnpfaD0DUDWM+YUWIpPx5qeYjRrNgOBIxEBhhQhIifvAd4jZDFlFzALQ3d49yaC97aELYbSjo6OjE1nEtddeawdVGbZpoHZpZs+yH3EaZuofAEmc8JdSwIe5QFa0V8FLU212sQzMRyLRjTOYDyfWAxLahGKEpsoTzegARy1qL4GiKCLstklhzZBtNtsx9AMhZgEAB+dKyI45whaCjF1zc3MAWcTh/fsLYJ2RoeMQKm268cYbB/C6tGGWlNJGZGY2Bw9Qr7+jpXUlIfp4UbI/CRm8as0nFwLzzwjbsIEPc6J4EMUIglGYWQMb3gP8iRpOMgGGh4OVFn4BE1EUFfQDIVYBwOAxhyVaKHhBovn9vhgKVNqUggm5j0V6AQLi7svhhIU1TDAc91Ws9p+2lEHpdVTYWgwTWLVqVZ/dpX2AUFp+XVXVS1mBfyvXmf97Og6haHFwNw0FlFGbcnJy+rxrWmAqzHf+azQ6aMkcsqMloeMgAFuBlqjaEUJQBpn4MGAmOY/Hk4IsgpaQnXl5CyGzeb2V+2MSAHCckoDR4Q4OiENiSuK+U/cMy58woczv9qwNaMrizz//PIx4OPkYVK6ZIMnglZq3EEVBW1vbMLPGElpFXLp0aS9TSyaVZHZ3dr4MVc2bIKZen5ae/mua4aMCCuajIPyZ2GOnr0/Kz7/G4+r50uv3PUi7oSLRsX///hGGSRgHxc5KKOJEfwuYlsMYJix5Aym1RKKql6B+QDXbpJz8qzRZ/kvAH3gN/v4MWUBMUYDu840ILVJQ0NyJ2+WeWZCbO9Xd1f0AlGELOY6vsNvFhyBcCZP8qcVT040OvTh0HE5Jq6hpMYdd7vZ2Dpm8nEwbR9d98cWiooKCepe7/TdQJCphWHYfZBhvPU3XVytXJiODjDGZO8bpdM744J33bpE19R9hiJVs4hNutzuimQsEPLkoPI1LWI7ZjvrpJgItIdMmGLhpxBl0gGAbOrm7uKDg28rq6obQeaWTS1O61K6S483N90IWcTZNZEFG8MU0u/15ZAExCYDi16iNMu3593s9tFOIgYcIiILt2eEXjnoWwp52s3t9PT35xCRVCvMPz7n9ds/WsjIUC+ypqcTbbRrqY1lWfqvICqbCwHNcZWJa6h2QF+hrInEFev2QEaETdU29JuDRZtF5kCU8xEvikvkLFqyJZp50WS8KDUXBmWzlWXYP6gcOh6PHrbpoE01YZARFquJuj3d1zvjs90ElVLOIlTWkD4eHch7tPjwDfIciKiiAbwS79NgNN9zwnVUzGlseQMACks3NhtHbnMPtcjikB7JyczdGK6CAep0FDnjYkWUxbiwbwA9KjR49uqWhpjYQ1CoeRJghGdQL5/kvEuzS0u3bt5+RK1U0BcwHSjNZFuy5wcC8DYmpyXdWVFTsr62NHo1BTiEsAoAwbo+UlNRvNZPWPMDUrPTp/oVmYaRBSLZGyH/AerqOddqIxaFTJpS259ls0rMaIq+AT+sOLU1HQ0w+gI6xH3/fjvU9YFwSpUfSM4bP2Fld/W20zafpXyh3XhN+xaAmwDrlQfj00099YHLKza5R1SpK4gvjsrN+XmHS1sUwuo5M1DMwtTMhKeG+hJSkWXTzUT+gfYHIpATM89zXkTKRoZhXV/cF8LEM0c5xc+Bek3DSYaXNWF02UXzuwrFjsmob659pbGx0oxgRkwZISEjYA2qqATzWSai3toFdtMUrITn5KZDgHVbW6GrtGgMPkE1DI2AYhEfsUXisA/A8xyCR9CUaIASBe1bTtYlwUi5CJzfUxUD1TRITnq6qq1pf29BgOi91xIgGCAsr4JkuQ72/2IJbQZV+lpSW+gTk2A8gi2hoaKB5/IuCx+B4ekGov7a6Rhl8/4KCic/WVld3qbJ8D+RJqMMd9CoZ1jAyusGuHOR5/uOUYWlvgi9ztK6xAQ0UMb8ZNHXq1HF+t3c+1GwVluc/r6mpod9uufxLvVVXa+s8UJdHJZRUs61hW2cs86MAT3E6C/yqfg3EVCpU8TbzdnullXJyYW7uBMPAC2SdnIBo5msrJz4UEyZMmEUU9dNgMwTCtDtZEudU1tcfj3U9WqeAXMkMUPYTwTRS59sPftNBm91eBVU/WlAYkt9ejP+AwxAhLzt7maKoy4PHQDuuaNpn7fW4s4X4r1QMAWgCSNPJpSHDtA2dmrQf7eZTxAVgCADO1yjjpL3uAyR/jtkSEmIvav2NEReAIYDi810E3nlm8BjDsxt27NhhuZn1bCEuAEMBA+eE9AAaNo57/Wz/ELQVxAVgCGDgMyuR4PzV5TqdlsO/s4m4AAwStBcR7H9wsYbY7fanBtBKflYQF4BBAkrLGVAh7evkhSTS1uzc3PfROYK4AAwShqbNON0gQ7ObUmLCA+fK6acY1E/EnE+gvZAel+vqdIy/Kq+r62syUQLK3FP/K0s26cFdu3ZtR+cQ4hrAIlwuV4o/IL/abhjLaUGLjsHfTI3o9PcHCJTAX7Trykp0jiGeCrYI+vKor8dNTzcGO1/Ocex3qqbfomvaeJtgey95WNpdQ9Wr/7dE3ARYhHryHYbeA6NpWin9D9F43y79OTUt7cGNGzeek/8oRtwEWATRSHCzJ03w0Fr8/4zIyLi/nxc+f9SImwCLcObkTIVsXx6UZ0cymDsiOMTNOy38EuePHYMSAPovhZWXlrKlpeUEl52sT5eVIq6sHFl6NXkwOIIypYtQ84DUbllpaZ/pG+V247srKzU8BFU7A2XZmjMDjrUZGSc1QjFCqV3jyI2DDAuBMNpnqOPInUIDxv8DZKm9PJ5yjaAAAAAASUVORK5CYII=",

  // Map sheet names to expected column headers, so later edits are easy.
  // Use exact case-insensitive matches; we‚Äôll match loosely by trimming.
    SHEET_MAP: {
    "EPM_TestCLogin": {
      moduleCol: "Module/Feature",
      idCol: "Test ID",
      titleCol: "Title/Description",
      fieldCol: "Field/Control ",       // trailing space present in file
      typeCol: "Test Type",
      preCol: "Preconditions",
      stepsCol: "Test Steps",
      dataCol: "Test Data",
      expectedCol: "Expected Result",
    },
    "Iraje EPM Post-Test Cases (Tem)": {
      moduleCol: "Module/Feature",
      idCol: "Test ID",
      titleCol: " Title/Description",   // leading space present in file
      fieldCol: "Field/Control ",       // trailing space
      typeCol: "Test Type",
      preCol: "Preconditions",
      stepsCol: "Test Steps",
      dataCol: "Test Data",
      expectedCol: "Expected Result",
    },
    "EPM_TestCPost": {
      moduleCol: "Module/Feature",
      idCol: "Test ID",
      titleCol: " Title/Description",   // leading space variant observed
      fieldCol: "Field/Control ",       // trailing space
      typeCol: "Test Type",
      preCol: "Preconditions",
      stepsCol: "Test Steps",
      dataCol: "Test Data",
      expectedCol: "Expected Result",
    },
    "Iraje EPM Post-Test Cases": {
      moduleCol: "Module/Feature",
      idCol: "Test ID",
      titleCol: " Title/Description",   // leading space variant
      fieldCol: "Field/Control ",       // trailing space
      typeCol: "Test Type",
      preCol: "Preconditions",
      stepsCol: "Test Steps",
      dataCol: "Test Data",
      expectedCol: "Expected Result",
    },
    "Iraje EPM Test Cases": {
      moduleCol: "Module/Feature",
      idCol: "Test ID",
      titleCol: "Title/Description",
      fieldCol: "Field/Control ",       // trailing space present
      typeCol: "Test Type",
      preCol: "Preconditions",
      stepsCol: "Test Steps",
      dataCol: "Test Data",
      expectedCol: "Expected Result",
    },
  },

  // Group display: "module" or "sheet"
  GROUP_BY: "module",

  // UI-only threshold (affects summary coloring if styled)
  PASS_THRESHOLD: 80,

  // Incremental render batch size
  RENDER_BATCH: 200,
};

// -------------------------
// State & DOM
// -------------------------
const els = {
  file: null,
  btnImport: null,
  sectionsRoot: null,
  summaryTbody: null,
  loadInfo: null,
  sheetPicker: null,
  sheetList: null,
  reportDate: null,
  testerName: null,
  signature: null,
  coverLogo: null,
};

const state = {
  workbook: null,
  sheets: [],
  selectedSheets: [],
  rowsByGroup: {}, // key -> test rows[]
  flatRows: [],    // all rows
  loadedCount: 0,
  loadMs: 0,
  storage: {
    headerKey: "epm_header",
    rowKeyPrefix: "epm_tc_", // + TestID
  },
};

// -------------------------
// Utilities
// -------------------------
function $(sel) { return document.querySelector(sel); }
function create(tag, attrs = {}, children = []) {
  const el = document.createElement(tag);
  Object.entries(attrs).forEach(([k, v]) => {
    if (k === "class") el.className = v;
    else if (k === "for") el.htmlFor = v;
    else if (k.startsWith("on") && typeof v === "function") el.addEventListener(k.substring(2), v);
    else el.setAttribute(k, v);
  });
  (Array.isArray(children) ? children : [children]).forEach(c => {
    if (c == null) return;
    if (typeof c === "string") el.appendChild(document.createTextNode(c));
    else el.appendChild(c);
  });
  return el;
}

function safeTrim(s) { return (s == null) ? "" : String(s).trim(); }
function normalizeHeaderKey(s) { return String(s || "").toLowerCase(); }
function nowMs() { return performance.now ? performance.now() : Date.now(); }
function fmtPct(pct) { return isFinite(pct) ? `${pct.toFixed(1)}%` : "0%"; }

function loadHeaderFromStorage() {
  try {
    const json = localStorage.getItem(state.storage.headerKey);
    if (!json) return;
    const obj = JSON.parse(json);
    if (obj.reportDate) els.reportDate.value = obj.reportDate;
    if (obj.testerName) els.testerName.value = obj.testerName;
    if (obj.signature) els.signature.value = obj.signature;
  } catch(e) {}
}
function saveHeader() {
  const obj = {
    reportDate: els.reportDate.value || "",
    testerName: els.testerName.value || "",
    signature: els.signature.value || "",
  };
  localStorage.setItem(state.storage.headerKey, JSON.stringify(obj));
}

// Persist by Test ID
function loadRowState(testId) {
  try {
    const json = localStorage.getItem(state.storage.rowKeyPrefix + testId);
    return json ? JSON.parse(json) : null;
  } catch(e) { return null; }
}
function saveRowState(testId, obj) {
  try {
    localStorage.setItem(state.storage.rowKeyPrefix + testId, JSON.stringify(obj));
  } catch(e) {}
}
function clearStorage() {
  const header = localStorage.getItem(state.storage.headerKey);
  localStorage.clear();
  if (header) localStorage.setItem(state.storage.headerKey, header);
  alert("Saved execution data cleared (header preserved).");
}

// -------------------------
// Excel Import
// -------------------------
function openSheetPicker(sheetNames) {
  els.sheetList.innerHTML = "";
  sheetNames.forEach(name => {
    const id = "sheet_" + Math.random().toString(36).slice(2);
    const row = create("div", { class: "sheet-row" }, [
      create("input", { type: "checkbox", id, value: name, checked: true }),
      create("label", { for: id }, name)
    ]);
    els.sheetList.appendChild(row);
  });
  els.sheetPicker.style.display = "flex";
}
function closeSheetPicker() {
  els.sheetPicker.style.display = "none";
}
function applySheetSelection() {
  const checks = els.sheetList.querySelectorAll("input[type=checkbox]");
  const selected = [];
  checks.forEach(ch => { if (ch.checked) selected.push(ch.value); });
  state.selectedSheets = selected;
  closeSheetPicker();
  if (!state.workbook) return;
  buildFromWorkbook(state.workbook, selected);
}

function readExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Failed to read file"));
    reader.onload = e => {
      try {
        const data = e.target.result;
        const wb = XLSX.read(data, { type: "binary", cellDates: false, cellNF: false, cellText: false });
        resolve(wb);
      } catch(err) { reject(err); }
    };
    reader.readAsBinaryString(file);
  });
}

function sheetToJsonWithHeaders(ws) {
  const o = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: "" });
  if (!o || !o.length) return { headers: [], rows: [] };
  // Heuristic: first row with >=3 non-empty cells is treated as header row
  let headerRowIdx = 0;
  for (let i = 0; i < o.length; i++) {
    const row = o[i];
    const nonEmpty = row.filter(c => safeTrim(c) !== "").length;
    if (nonEmpty >= 3) { headerRowIdx = i; break; }
  }
  const headers = (o[headerRowIdx] || []).map(h => String(h ?? ""));
  const rows = o.slice(headerRowIdx + 1);
  return { headers, rows };
}

function makeHeaderIndex(headers) {
  const idx = {};
  headers.forEach((h, i) => {
    const norm = normalizeHeaderKey(h);
    if (!(norm in idx)) idx[norm] = i;
    // also allow exact key lookups
    idx[h] = i;
  });
  return idx;
}

function resolveColIndex(headerIndex, configuredName) {
  if (!configuredName) return -1;
  // exact
  if (configuredName in headerIndex) return headerIndex[configuredName];
  // trimmed
  const trimmed = configuredName.trim();
  if (trimmed && (trimmed in headerIndex)) return headerIndex[trimmed];
  // normalized
  const norm = normalizeHeaderKey(configuredName);
  if (norm in headerIndex) return headerIndex[norm];
  // fallback: scan keys for trimmed equality
  for (const key in headerIndex) {
    if (safeTrim(key) === trimmed) return headerIndex[key];
  }
  return -1;
}

function isNonDataRow(firstCell) {
  const t = normalizeHeaderKey(firstCell || "");
  if (!t) return false;
  if (t.includes("iraje pam test cases summary")) return true;
  if (t.startsWith("total:")) return true;
  if (t.startsWith("execution coverage:")) return true;
  return false;
}

function parseSheet(sheetName, ws) {
  const map = CONFIG.SHEET_MAP[sheetName];
  const { headers, rows } = sheetToJsonWithHeaders(ws);
  const headerIndex = makeHeaderIndex(headers);

  const colIdx = (map ? {
    module: resolveColIndex(headerIndex, map.moduleCol),
    id: resolveColIndex(headerIndex, map.idCol),
    title: resolveColIndex(headerIndex, map.titleCol),
    field: resolveColIndex(headerIndex, map.fieldCol),
    type: resolveColIndex(headerIndex, map.typeCol),
    pre: resolveColIndex(headerIndex, map.preCol),
    steps: resolveColIndex(headerIndex, map.stepsCol),
    data: resolveColIndex(headerIndex, map.dataCol),
    expected: resolveColIndex(headerIndex, map.expectedCol),
  } : {
    module: -1, id: -1, title: -1, field: -1, type: -1, pre: -1, steps: -1, data: -1, expected: -1,
  });

  const out = [];
  for (const r of rows) {
    const firstCell = r[0];
    if (isNonDataRow(firstCell)) continue;

    const testId = safeTrim(colIdx.id >= 0 ? r[colIdx.id] : "");
    const title = safeTrim(colIdx.title >= 0 ? r[colIdx.title] : "");
    if (!testId && !title) continue;

    const module = safeTrim(colIdx.module >= 0 ? r[colIdx.module] : sheetName);
    const field = safeTrim(colIdx.field >= 0 ? r[colIdx.field] : "");
    const type = safeTrim(colIdx.type >= 0 ? r[colIdx.type] : "");
    const pre = safeTrim(colIdx.pre >= 0 ? r[colIdx.pre] : "");
    const steps = safeTrim(colIdx.steps >= 0 ? r[colIdx.steps] : "");
    const data = safeTrim(colIdx.data >= 0 ? r[colIdx.data] : "");
    const expected = safeTrim(colIdx.expected >= 0 ? r[colIdx.expected] : "");

    out.push({
      sheet: sheetName,
      module,
      id: testId || `(no-id) ${module} ${title.slice(0,30)}`,
      title,
      field,
      type,
      pre,
      steps,
      data,
      expected,
    });
  }
  return out;
}

async function buildFromWorkbook(wb, sheetNames) {
  const t0 = nowMs();
  state.rowsByGroup = {};
  state.flatRows = [];
  state.loadedCount = 0;

  let usedSheets = 0;
  sheetNames.forEach(name => {
    if (!wb.Sheets[name]) return;
    usedSheets++;
    const rows = parseSheet(name, wb.Sheets[name]);
    rows.forEach(row => {
      const groupKey = (CONFIG.GROUP_BY === "module")
        ? (row.module || row.sheet || "General")
        : row.sheet;
      if (!state.rowsByGroup[groupKey]) state.rowsByGroup[groupKey] = [];
      state.rowsByGroup[groupKey].push(row);
      state.flatRows.push(row);
    });
  });

  state.loadedCount = state.flatRows.length;
  state.loadMs = Math.max(1, nowMs() - t0);

  els.sectionsRoot.innerHTML = "";
  renderAllSectionsIncremental();

  els.loadInfo.textContent = `Loaded ${state.loadedCount} tests from ${usedSheets} sheet(s) in ${state.loadMs.toFixed(0)}ms.`;

  updateSummary();
}

function renderAllSectionsIncremental() {
  const keys = Object.keys(state.rowsByGroup).sort();
  let gi = 0;

  function renderNextGroup() {
    if (gi >= keys.length) return;
    const key = keys[gi++];
    const container = renderGroupContainer(key);
    const rows = state.rowsByGroup[key] || [];
    let idx = 0;

    function renderBatch() {
      const end = Math.min(idx + CONFIG.RENDER_BATCH, rows.length);
      for (; idx < end; idx++) {
        container.body.appendChild(renderRow(rows[idx]));
      }
      if (idx < rows.length) {
        requestIdleCallback ? requestIdleCallback(renderBatch) : setTimeout(renderBatch, 0);
      } else {
        renderNextGroup();
      }
    }
    renderBatch();
  }
  renderNextGroup();
}

function renderGroupContainer(groupKey) {
  const section = create("section", {}, [
    create("h2", {}, groupKey),
    create("div", { class: "meta" }, `Items render below.`),
    create("ul", { class: "checklist" })
  ]);
  els.sectionsRoot.appendChild(section);
  return { root: section, body: section.querySelector("ul.checklist") };
}

function renderRow(row) {
  const li = create("li");

  const saved = loadRowState(row.id) || {};

  const header = create("div", {}, [
    create("label", {}, `${row.id} ‚Äî ${row.title}`),
    create("div", { class: "meta" }, [
      create("span", {}, `Sheet: ${row.sheet}`),
      create("span", { class: "badge" }, row.module ? `Module: ${row.module}` : ""),
      create("span", { class: "badge" }, row.type ? `Type: ${row.type}` : ""),
      create("span", { class: "badge" }, row.field ? `Field: ${row.field}` : ""),
    ])
  ]);

  const details = create("div", {}, [
    row.pre ? create("div", {}, [create("strong", {}, "Preconditions: "), row.pre]) : null,
    row.steps ? create("div", {}, [create("strong", {}, "Steps: "), row.steps]) : null,
    row.data ? create("div", {}, [create("strong", {}, "Test Data: "), row.data]) : null,
    row.expected ? create("div", {}, [create("strong", {}, "Expected: "), row.expected]) : null,
  ].filter(Boolean));

  const statusSel = create("select", {},
    ["", "Pass", "Fail", "Blocked"].map(val => {
      const opt = create("option", { value: val }, val || "‚Äî Select Status ‚Äî");
      if ((saved.status || "") === val) opt.selected = true;
      return opt;
    })
  );
  statusSel.addEventListener("change", () => {
    persist();
    updateSummary();
  });

  const notes = create("textarea", { rows: "3", placeholder: "Notes / Observations" }, saved.notes || "");
  notes.addEventListener("input", persist);

  const imageInput = create("input", { type: "file", accept: "image/*" });
  const imagePreview = create("div", { class: "image-preview" });
  if (saved.images && Array.isArray(saved.images)) {
    saved.images.forEach(src => {
      const img = new Image();
      img.src = src;
      imagePreview.appendChild(img);
    });
  }
  imageInput.addEventListener("change", async () => {
    const files = Array.from(imageInput.files || []);
    for (const f of files) {
      const b64 = await fileToDataURL(f);
      const img = new Image();
      img.src = b64;
      imagePreview.appendChild(img);
      const cur = loadRowState(row.id) || {};
      cur.images = Array.isArray(cur.images) ? cur.images : [];
      cur.images.push(b64);
      saveRowState(row.id, cur);
    }
  });

  const controls = create("div", {}, [
    create("div", {}, [
      create("strong", {}, "Status: "),
      statusSel
    ]),
    create("div", {}, [
      create("strong", {}, "Notes: "),
      notes
    ]),
    create("div", {}, [
      create("strong", {}, "Attach screenshot(s): "),
      imageInput,
      imagePreview
    ])
  ]);

  li.appendChild(header);
  li.appendChild(details);
  li.appendChild(controls);

  function persist() {
    const obj = {
      status: statusSel.value || "",
      notes: notes.value || "",
      images: (loadRowState(row.id)?.images) || [],
    };
    saveRowState(row.id, obj);
  }

  return li;
}

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onerror = () => reject(new Error("Failed to read image"));
    r.onload = e => resolve(e.target.result);
    r.readAsDataURL(file);
  });
}

// -------------------------
// Summary
// -------------------------
function computeSummary() {
  const summary = {};
  const rows = state.flatRows || [];
  rows.forEach(r => {
    const key = (CONFIG.GROUP_BY === "module") ? (r.module || r.sheet || "General") : r.sheet;
    if (!summary[key]) summary[key] = { total: 0, pass: 0, fail: 0, blocked: 0 };
    summary[key].total += 1;
    const s = (loadRowState(r.id)?.status || "").toLowerCase();
    if (s === "pass") summary[key].pass += 1;
    else if (s === "fail") summary[key].fail += 1;
    else if (s === "blocked") summary[key].blocked += 1;
  });
  return summary;
}

function updateSummary() {
  const tbody = els.summaryTbody;
  tbody.innerHTML = "";
  const data = computeSummary();
  const keys = Object.keys(data).sort();
  keys.forEach(k => {
    const s = data[k];
    const passPct = s.total ? (100 * s.pass / s.total) : 0;
    const tr = create("tr", {}, [
      create("td", {}, k),
      create("td", {}, String(s.total)),
      create("td", {}, String(s.pass)),
      create("td", {}, String(s.fail + s.blocked)),
      create("td", {}, fmtPct(passPct)),
    ]);
    tbody.appendChild(tr);
  });
}

// -------------------------
// DOCX Export (with screenshots)
// -------------------------
async function exportDocx() {
  if (!window.docx) {
    alert("DOCX library not loaded.");
    return;
  }
  const { Document, Packer, Paragraph, HeadingLevel, Table, TableRow, TableCell, AlignmentType, Media } = docx;

  // Build document
  const doc = new Document({ sections: [] });

  // Cover section
  const headerInfo = {
    date: els.reportDate?.value || "",
    tester: els.testerName?.value || "",
    signature: els.signature?.value || "",
  };

  const coverChildren = [];
  // Optional logo
  if (CONFIG.LOGO_DATA_URL) {
    try {
      const blob = await fetchDataUrlAsBlob(CONFIG.LOGO_DATA_URL);
      const img = Media.addImage(doc, blob, 200, 60);
      coverChildren.push(new Paragraph({ children: [img], alignment: AlignmentType.CENTER }));
    } catch(e) {}
  }
  coverChildren.push(
    new Paragraph({ text: "Iraje EPM Testing Report", heading: HeadingLevel.TITLE, alignment: AlignmentType.CENTER }),
    new Paragraph({ text: `Date: ${headerInfo.date}`, alignment: AlignmentType.CENTER }),
    new Paragraph({ text: `Tester: ${headerInfo.tester}`, alignment: AlignmentType.CENTER }),
    new Paragraph({ text: `Signature: ${headerInfo.signature}`, alignment: AlignmentType.CENTER }),
    new Paragraph({ text: " " })
  );
  doc.addSection({ children: coverChildren });

  // Summary section
  const summary = computeSummary();
  const summaryRows = [
    new TableRow({
      children: [
        new TableCell({ children: [new Paragraph({ text: "Module" })] }),
        new TableCell({ children: [new Paragraph({ text: "Total" })] }),
        new TableCell({ children: [new Paragraph({ text: "Passed" })] }),
        new TableCell({ children: [new Paragraph({ text: "Failed/Blocked" })] }),
        new TableCell({ children: [new Paragraph({ text: "% Pass" })] }),
      ]
    })
  ];
  Object.keys(summary).sort().forEach(k => {
    const s = summary[k];
    const passPct = s.total ? (100 * s.pass / s.total) : 0;
    summaryRows.push(new TableRow({
      children: [
        new TableCell({ children: [new Paragraph({ text: k })] }),
        new TableCell({ children: [new Paragraph({ text: String(s.total) })] }),
        new TableCell({ children: [new Paragraph({ text: String(s.pass) })] }),
        new TableCell({ children: [new Paragraph({ text: String(s.fail + s.blocked) })] }),
        new TableCell({ children: [new Paragraph({ text: fmtPct(passPct) })] }),
      ]
    }));
  });
  doc.addSection({
    children: [
      new Paragraph({ text: "Automated Summary", heading: HeadingLevel.HEADING_1 }),
      new Table({ rows: summaryRows }),
      new Paragraph({ text: " " }),
    ]
  });

  // Detail sections per group
  const keys = Object.keys(state.rowsByGroup).sort();
  for (const groupKey of keys) {
    const rows = state.rowsByGroup[groupKey] || [];
    const children = [
      new Paragraph({ text: groupKey, heading: HeadingLevel.HEADING_1 }),
    ];
    for (const r of rows) {
      const saved = loadRowState(r.id) || {};
      children.push(new Paragraph({ text: `${r.id} ‚Äî ${r.title}`, heading: HeadingLevel.HEADING_2 }));

      const metaLine = [
        r.sheet ? `Sheet: ${r.sheet}` : null,
        r.module ? `Module: ${r.module}` : null,
        r.type ? `Type: ${r.type}` : null,
        r.field ? `Field: ${r.field}` : null,
      ].filter(Boolean).join(" | ");
      if (metaLine) children.push(new Paragraph({ text: metaLine }));

      if (r.pre) children.push(new Paragraph({ text: `Preconditions: ${r.pre}` }));
      if (r.steps) children.push(new Paragraph({ text: `Steps: ${r.steps}` }));
      if (r.data) children.push(new Paragraph({ text: `Test Data: ${r.data}` }));
      if (r.expected) children.push(new Paragraph({ text: `Expected: ${r.expected}` }));

      children.push(new Paragraph({ text: `Status: ${saved.status || ""}` }));
      if (saved.notes) children.push(new Paragraph({ text: `Notes: ${saved.notes}` }));

      if (saved.images && Array.isArray(saved.images) && saved.images.length) {
        children.push(new Paragraph({ text: "Screenshots:", heading: HeadingLevel.HEADING_3 }));
        for (const src of saved.images) {
          try {
            const blob = await fetchDataUrlAsBlob(src);
            const image = Media.addImage(doc, blob, 400, 225);
            children.push(new Paragraph({ children: [image] }));
          } catch(e) {}
        }
      }

      children.push(new Paragraph({ text: " " }));
    }
    doc.addSection({ children });
  }

  const packer = new Packer();
  const buf = await packer.toBlob(doc);
  saveAs(buf, `Iraje_EPM_Testing_Report_${Date.now()}.docx`);
}

async function fetchDataUrlAsBlob(dataUrl) {
  const res = await fetch(dataUrl);
  return await res.blob();
}

// -------------------------
// Events / Init
// -------------------------
function bindDom() {
  els.file = $("#excelFile");
  els.btnImport = $("#btnImport");
  els.sectionsRoot = $("#sectionsRoot");
  els.summaryTbody = $("#summaryTable tbody");
  els.loadInfo = $("#loadInfo");
  els.sheetPicker = $("#sheetPicker");
  els.sheetList = $("#sheetList");
  els.reportDate = $("#reportDate");
  els.testerName = $("#testerName");
  els.signature = $("#signature");
  els.coverLogo = $("#coverLogo");

  if (CONFIG.LOGO_DATA_URL && els.coverLogo) {
    els.coverLogo.src = CONFIG.LOGO_DATA_URL;
  }

  loadHeaderFromStorage();

  els.btnImport?.addEventListener("click", async () => {
    const f = els.file?.files && els.file.files[0];
    if (!f) { alert("Please choose an Excel file first."); return; }
    try {
      const wb = await readExcel(f);
      state.workbook = wb;
      const sheetNames = wb.SheetNames || [];
      state.sheets = sheetNames;

      const defaultSheets = Object.keys(CONFIG.SHEET_MAP).filter(s => sheetNames.includes(s));
      openSheetPicker(defaultSheets.length ? defaultSheets : sheetNames);
    } catch (e) {
      console.error(e);
      alert("Failed to read Excel. Please ensure the file is a valid .xlsx.");
    }
  });
}

window.addEventListener("DOMContentLoaded", bindDom);

// Expose functions to buttons in HTML
window.saveHeader = saveHeader;
window.clearStorage = clearStorage;
window.applySheetSelection = applySheetSelection;
window.closeSheetPicker = closeSheetPicker;
window.exportDocx = exportDocx;

</script>
<!-- Project Resume Dialog -->
<div class="modal" id="projectResumeModal">
  <div class="modal-content project-modal">
    <div class="modal-header">
      <h3><i class="fas fa-history"></i> Project Found</h3>
    </div>
    <div class="modal-body">
      <div class="project-info">
        <div class="project-icon">
          <i class="fas fa-folder-open"></i>
        </div>
        <div class="project-details">
          <h4 id="projectFileName">Project Name</h4>
          <p id="projectLastModified">Last modified: --</p>
          <p id="projectTestCount">Test cases: --</p>
        </div>
      </div>
      <p class="project-question">We found a saved project with this name. What would you like to do?</p>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="ProjectManager.chooseFreshStart()">
        <i class="fas fa-refresh"></i>
        Fresh Start
      </button>
      <button class="btn-primary" onclick="ProjectManager.resumeProject()">
        <i class="fas fa-play"></i>
        Resume Last Session
      </button>
    </div>
  </div>
</div>

<!-- Clear Data Confirmation Modal -->
<div class="modal" id="clearDataModal">
  <div class="modal-content danger-modal">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Clear All Saved Data</h3>
    </div>
    <div class="modal-body">
      <p><strong>Warning:</strong> This action will permanently delete:</p>
      <ul>
        <li>All test case progress and status</li>
        <li>All saved notes and comments</li>
        <li>All uploaded screenshots</li>
        <li>All project data</li>
      </ul>
      <p>This action cannot be undone. Are you sure you want to continue?</p>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeClearDataModal()">Cancel</button>
      <button class="btn-danger" onclick="confirmClearData()">
        <i class="fas fa-trash-alt"></i>
        Clear All Data
      </button>
    </div>
  </div>
</div>

<!-- Delete Sheet Confirmation Modal -->
<div class="modal" id="deleteSheetModal">
  <div class="modal-content danger-modal">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Delete All Test Cases</h3>
    </div>
    <div class="modal-body">
      <p><strong>Critical Action:</strong> This will permanently delete all imported test cases from the workspace.</p>
      <p>To confirm this action, type <strong>DELETE</strong> in the box below:</p>
      <input type="text" id="deleteConfirmInput" placeholder="Type DELETE to confirm" class="confirm-input">
      <div class="validation-error" id="deleteValidationError" style="display: none;">
        Please type "DELETE" exactly to confirm this action.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeDeleteSheetModal()">Cancel</button>
      <button class="btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteSheet()" disabled>
        <i class="fas fa-trash-alt"></i>
        Delete All Test Cases
      </button>
    </div>
  </div>
</div>

<!-- Success Notification -->
<div class="notification success" id="successNotification" style="display: none;">
  <i class="fas fa-check-circle"></i>
  <span id="successMessage"></span>
  <button onclick="closeNotification('success')" class="notification-close">&times;</button>
</div>

<!-- Error Notification -->
<div class="notification error" id="errorNotification" style="display: none;">
  <i class="fas fa-exclamation-circle"></i>
  <span id="errorMessage"></span>
  <button onclick="closeNotification('error')" class="notification-close">&times;</button>
</div>

<!-- External libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Application modules -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/storage.js"></script>
<script src="js/project-manager.js"></script>
<script src="js/excel-handler.js"></script>
<script src="js/ui-renderer.js"></script>
<script src="js/summary.js"></script>
<script src="js/navigation.js"></script>
<script src="js/dashboard.js"></script>
<script src="js/notifications.js"></script>
<script src="js/report-generator.js"></script>
<script src="js/main.js"></script>
</body>
</html>
